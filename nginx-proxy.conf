# 微信公众号API反向代理配置
# 使用说明：
# 1. 将 mp.miyucaicai.cn 替换为你的实际域名
# 2. 配置SSL证书（建议使用Let's Encrypt免费证书）
# 3. 确保你的服务器IP已在微信公众平台白名单中

server {
    listen 80;
    listen 443 ssl http2;
    server_name mp.miyucaicai.cn;
    
    # SSL证书配置（如果使用HTTPS）
    # ssl_certificate /path/to/your/certificate.crt;
    # ssl_certificate_key /path/to/your/private.key;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 日志配置
    access_log /var/log/nginx/wechat_proxy.access.log;
    error_log /var/log/nginx/wechat_proxy.error.log;
    
    # 根路径代理到微信API
    location / {
        # 微信API目标地址
        proxy_pass https://api.weixin.qq.com;
        
        # 保留原始请求头
        proxy_set_header Host api.weixin.qq.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 连接和读取超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 支持大文件上传（图片素材）
        client_max_body_size 10M;
        proxy_request_buffering off;
    }
    
    # 健康检查端点（可选）
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTP重定向到HTTPS（如果使用SSL）
server {
    listen 80;
    server_name mp.miyucaicai.cn;
    return 301 https://$server_name$request_uri;
}

# 简化版本（仅HTTP，适合测试）
# server {
#     listen 80;
#     server_name mp.miyucaicai.cn;
#     
#     location / {
#         proxy_pass https://api.weixin.qq.com;
#         proxy_set_header Host api.weixin.qq.com;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_connect_timeout 30s;
#         client_max_body_size 10M;
#     }
# }